/* Copyright 2018 (c) - DAMN GOOD - All rights reserved */

var tr, filename, $cc = $("#cc"),
    cc = "",
    cct = "",
    ccm = "",
    done = 0,
    langauge = "";
final_file = "test0";

console.log("Hello World");

function translate() {
    $tr = $cc.find(".translate"), $trl = $tr.length, done = 0, $tr.unbind("DOMSubtreeModified"), $tr.bind("DOMSubtreeModified", function() {
        $(this).removeClass("translate").addClass("translated").unbind("DOMSubtreeModified");
        var e = ++done / $tr.length * 100;
        $(".progress-bar-fill").css("width", e.toFixed(2) + "%"), 100 == e && finished()
    })
}

function finished() {
    console.log("reached finished");
    $("#select_lang").fadeOut(null, function() {
        $("#done").fadeIn()
    })

}

function download() {
    cct = "", $('#cc font[style="vertical-align: inherit;"]').each(function() {
        $(this).replaceWith(this.childNodes)
    });
    var e = "",
        t = "";
    $("#ko").get(0).checked && ($("#ou").get(0).checked ? (e = "{\\an2}", t = "{\\an8}") : (e = "{\\an8}", t = "{\\an2}")), $("#cc tr").each(function(n) {
        var a = "";
        $(this).find("td").each(function() {
            $(this).hasClass("translated") ? (cct += a + e, $(this).contents().each(function() {
                "BR" == this.tagName ? cct += "\n" : cct += $(this).html() || this.nodeValue
            }), cct += "\n\n") : a += $(this).text().trim() + "\n"
        }), $("#ko").get(0).checked && (cct += a + t + $("td.translated[data-original]", this).data("original") + "\n\n")
    });
    var n = $(".goog-te-combo").val();
    $("#ko").get(0).checked && ($("#ou").get(0).checked ? n = "org-" + n : n += "-org");
    var a = filename.split(".");
    console.log(a);
    a.splice(a.length - 1, 0, n), filename = a.join("."), $("#download").attr("href", "data:plain/text;charset=UTF-8," + encodeURIComponent(cct)).attr("download", filename)
    final_file = "test";
    console.log(cct);
}

function save_db() {
    
    $("#save").hide(); 
    
    console.log("ashse1");
    cct = "", $('#cc font[style="vertical-align: inherit;"]').each(function() {
        $(this).replaceWith(this.childNodes)
    });
    var e = "",
        t = "";
    $("#ko").get(0).checked && ($("#ou").get(0).checked ? (e = "{\\an2}", t = "{\\an8}") : (e = "{\\an8}", t = "{\\an2}")), $("#cc tr").each(function(n) {
        var a = "";
        $(this).find("td").each(function() {
            $(this).hasClass("translated") ? (cct += a + e, $(this).contents().each(function() {
                "BR" == this.tagName ? cct += "\n" : cct += $(this).html() || this.nodeValue
            }), cct += "\n\n") : a += $(this).text().trim() + "\n"
        }), $("#ko").get(0).checked && (cct += a + t + $("td.translated[data-original]", this).data("original") + "\n\n")
    });
    var n = $(".goog-te-combo").val();
    $("#ko").get(0).checked && ($("#ou").get(0).checked ? n = "org-" + n : n += "-org");

    //var a = filename.split(".");
    //a.splice(a.length - 1, 0, n), filename = a.join("."), $("#save").attr("href", "data:plain/text;charset=UTF-8," + encodeURIComponent(cct)).attr("download", filename)

    //console.log("data:plain/text;charset=UTF-8," + encodeURIComponent(cct))
    //document.getElementById("subtitle_content").value = cct;
    console.log("ashse");
    //savedb();
    var php_var = document.getElementById("subtitle").value+".srt";
    var srt = document.getElementById('srt_text').innerHTML;
    var subtitle = document.getElementById("subtitle").value;
    var language = document.getElementById('country').value;
    var author = document.getElementById('author').value;
    console.log(php_var);
    console.log(subtitle);
    console.log(language);
    $.ajax({
        type: "POST",
        url: "save_database.php",
        data: {
            file: php_var,
            srt: cct,
            subtitle: subtitle,
            language: language,
        },
        cache: false,

        success: function (data) {
            console.log(data);

            alert(data);
            setTimeout(function(){
                window.location = 'https://translatesubtitles.com/browse_subtitle.php';
            }, 10);
        },
    });

}

function googleTranslateElementInit() {
    tr = new google.translate.TranslateElement({}, "google_translate_element")
}

function disable() {
    $(".goog-te-banner-frame").contents().find('[id=":0.restore"]').trigger("click")
}

function enable() {
    $(".goog-te-banner-frame").contents().find('[id=":0.confirm"]').trigger("click")
}

function process(e) {
    if (ccm = e.replace(/\r/g, '').match(/^(.*)$/gm)) {
        var t = $("<tr/>");
        $cc.append(t);
        var n = 0;
        ccm.forEach(function(e) {
            if ("" == e.trim()) return t = $("<tr/>"), $cc.append(t), void(n = 0);
            n < 3 ? ($td = $("<td/>"), 2 == n && $td.addClass("translate")) : e = $td.text() + "\n" + e + "\n", $td.html(e.replace(/\n/g, "<br>").replace(/([A-Z]{4,})/g, function(v) {
                return v[0] + v.toLowerCase().slice(1);
            })), $td.attr("data-original", e), t.append($td), n++
        }), translate()
    }
}

function start(e) {
    console.log("processing...");
    cc = cc || this.result, filename = $("#file").val().split("\\").pop(), language = $(".goog-te-combo option:selected").text(), $(".info").text(filename + " to " + language), $("#select_file").fadeOut(null, function() {
        $("#select_lang").fadeIn()
    }), $cc.html(""), $(".progress-bar-fill").css("width", "0%"), process(cc)
}

function load() {
    console.log("on load");
    setTimeout(function() {
        var e = $("#file").get(0).files[0],
            t = new FileReader;
        t.readAsText(e), t.onload = start
    }, 0)
}

function ko(e) {
    console.log(this.checked), this.checked ? $("#align").fadeIn() : $("#align").fadeOut()
}



$("#download").on("click", download), $("#select_lang").on("change", ".goog-te-combo", start), $("#file").on("change", function() {
    $("#select_file").fadeOut(null, function() {
        $("#select_lang").fadeIn()
    }), setTimeout(load, 50)
}), $("#ko").on("change", ko), $("#ko").get(0).checked && $("#ko").trigger("change"), $("#again").on("click", function() {
    window.location.reload()
});


$("#save").on("click", save_db), $("#select_lang").on("change", ".goog-te-combo", start), $("#file").on("change", function() {
    $("#select_file").fadeOut(null, function() {
        $("#select_lang").fadeIn()
    }), setTimeout(load, 50)
}), $("#ko").on("change", ko), $("#ko").get(0).checked && $("#ko").trigger("change"), $("#again").on("click", function() {
    window.location.reload()
});